# PRODIGY Binding Affinity Prediction

## Overview

This pipeline now includes optional **PRODIGY** (PROtein binDIng enerGY prediction) analysis for evaluating the predicted binding affinity of protein-protein complexes generated by Boltzgen. PRODIGY is a fast, structure-based binding affinity predictor that uses interface properties to estimate binding free energy (ΔG) and dissociation constant (Kd).

### What is PRODIGY?

PRODIGY is a contact-based method developed by the Bonvin lab (Utrecht University) that predicts binding affinity from structural information. It analyzes:

- **Buried Surface Area (BSA)**: Contact surface between binding partners
- **Interface Contacts (ICs)**: Number of residue-residue contacts at the interface
- **Charged and Apolar Residues**: Composition of the binding interface
- **Binding Free Energy (ΔG)**: Predicted binding affinity in kcal/mol
- **Dissociation Constant (Kd)**: Equilibrium dissociation constant in Molar units

## Enabling PRODIGY Analysis

To enable PRODIGY analysis in your workflow, add the following parameter:

```bash
nextflow run main.nf \
  --input samplesheet.csv \
  --run_prodigy \
  --outdir results
```

### Optional Parameters

#### Chain Selection

By default, PRODIGY will auto-detect chains in your structure. For binary complexes, it typically identifies chains A and B. You can manually specify chain selection:

```bash
--prodigy_selection 'A,B'
```

For multi-chain complexes targeting specific interfaces:

```bash
--prodigy_selection 'A,B,C'
```

## Output Files

When PRODIGY is enabled, you'll find the following outputs for each final ranked design:

### Directory Structure

```
results/
└── sample_id/
    └── prodigy/
        ├── design_1_prodigy_results.txt      # Full PRODIGY output
        ├── design_1_prodigy_summary.csv      # Parsed metrics
        ├── design_2_prodigy_results.txt
        ├── design_2_prodigy_summary.csv
        └── ...
```

### Raw Results (`*_prodigy_results.txt`)

Complete PRODIGY output including all calculated properties:

```
[+] Reading structure file: design_1.cif
[+] Parsed structure file design_1 (1 model(s))
[+] Setting selection: A,B
[+] Found 2 chains in structure: A, B
[+] Calculating buried surface area...
[+] Buried Surface Area: 1543.21 A^2
[+] Number of interface contacts (ICs): 89
[+] Number of non-interacting surface residues: 34
[+] Number of charged residues in ICs: 15
[+] Percentage of charged residues in ICs: 16.85%
[+] Number of apolar residues in ICs: 48
[+] Percentage of apolar residues in ICs: 53.93%
[+] Predicted binding affinity (ΔG): -11.2 kcal/mol
[+] Predicted dissociation constant (Kd): 5.4e-09 M at 25.0˚C
```

### CSV Summary (`*_prodigy_summary.csv`)

Parsed metrics in a machine-readable format for easy comparison:

| Column | Description | Units |
|--------|-------------|-------|
| `structure_id` | Unique identifier for the structure | - |
| `buried_surface_area_A2` | Total buried surface area | Ų |
| `num_interface_contacts` | Number of interface contacts | count |
| `num_noninteracting_surface` | Non-interacting surface residues | count |
| `num_charged_residues` | Charged residues at interface | count |
| `percent_charged_residues` | Percentage of charged residues | % |
| `num_apolar_residues` | Apolar residues at interface | count |
| `percent_apolar_residues` | Percentage of apolar residues | % |
| `predicted_binding_affinity_kcal_mol` | Predicted ΔG | kcal/mol |
| `predicted_kd_M` | Predicted dissociation constant | M (Molar) |
| `kd_temperature_C` | Temperature for Kd calculation | °C |

## Interpreting Results

### Binding Affinity (ΔG)

- **Stronger binding**: More negative ΔG values (e.g., -15 kcal/mol)
- **Weaker binding**: Less negative ΔG values (e.g., -5 kcal/mol)
- **Typical range**: -5 to -20 kcal/mol for protein-protein interactions

### Dissociation Constant (Kd)

- **Tighter binding**: Lower Kd values (e.g., 1e-12 M = picomolar)
- **Weaker binding**: Higher Kd values (e.g., 1e-6 M = micromolar)
- **Typical ranges**:
  - High affinity: nM to pM (10⁻⁹ to 10⁻¹² M)
  - Moderate affinity: μM (10⁻⁶ M)
  - Low affinity: mM (10⁻³ M)

### Interface Properties

- **Buried Surface Area**: Larger BSA generally correlates with stronger binding (typical range: 800-3000 Ų)
- **Interface Contacts**: More contacts suggest more stable interfaces (typical range: 40-150 contacts)
- **Charged vs. Apolar Residues**: Balance affects binding specificity and strength

## Integration with Other Metrics

PRODIGY complements other pipeline outputs:

1. **IPSAE scores** (if enabled with `--run_ipsae`): Evaluates protein-protein interface confidence
2. **Boltzgen confidence scores**: pLDDT and PAE metrics from structure prediction
3. **PRODIGY affinity**: Estimates binding thermodynamics

Together, these metrics provide a comprehensive evaluation of designed binders:

- **High IPSAE + Favorable PRODIGY**: Strong, well-structured interface with good predicted affinity
- **High confidence + Poor PRODIGY**: Structure is well-predicted but binding may be weak
- **Low IPSAE + Good PRODIGY**: Predicted affinity is good but interface structure is uncertain

## Example Workflow

### Complete Pipeline with PRODIGY

```bash
# Run target-based design with PRODIGY analysis
nextflow run main.nf \
  --input target_samplesheet.csv \
  --mode target \
  --run_prodigy \
  --run_ipsae \
  --num_designs 1000 \
  --budget 10 \
  --outdir results
```

### Analyzing Results

```python
import pandas as pd
import glob

# Collect all PRODIGY summaries
prodigy_files = glob.glob('results/*/prodigy/*_summary.csv')

# Combine into single dataframe
df_list = []
for file in prodigy_files:
    df = pd.read_csv(file)
    df_list.append(df)

combined_df = pd.concat(df_list, ignore_index=True)

# Sort by binding affinity (most negative = strongest)
top_binders = combined_df.sort_values('predicted_binding_affinity_kcal_mol')

# Filter for high-affinity designs (< -10 kcal/mol)
high_affinity = combined_df[combined_df['predicted_binding_affinity_kcal_mol'] < -10]

print(f"Top 10 predicted binders:")
print(top_binders[['structure_id', 'predicted_binding_affinity_kcal_mol', 'predicted_kd_M']].head(10))
```

## Advanced Usage

### Per-Sample Chain Selection

You can specify different chain selections for different samples in your samplesheet by adding a `prodigy_selection` column:

```csv
sample_id,target_structure,target_chain_ids,prodigy_selection
sample1,target1.pdb,A,A,B
sample2,target2.pdb,C,D,C,D,E
```

### Post-Processing Analysis

The CSV summaries can be easily integrated into downstream analysis:

```bash
# Concatenate all summaries
cat results/*/prodigy/*_summary.csv | grep -v "^structure_id" > all_prodigy_results.csv

# Add header
echo "structure_id,buried_surface_area_A2,num_interface_contacts,..." | \
  cat - all_prodigy_results.csv > all_prodigy_with_header.csv
```

## Citations

If you use PRODIGY in your research, please cite:

**PRODIGY**:
- Vangone, A. and Bonvin, A.M.J.J. (2015). Contacts-based prediction of binding affinity in protein-protein complexes. eLife, 4, e07454.
- Xue, L.C., Rodrigues, J.P., Kastritis, P.L., Bonvin, A.M.J.J., Vangone, A. (2016). PRODIGY: a web server for predicting the binding affinity of protein-protein complexes. Bioinformatics, 32(23), 3676-3678.

**PRODIGY Web Server**: https://wenmr.science.uu.nl/prodigy/

## Troubleshooting

### PRODIGY fails to detect chains

**Solution**: Manually specify chains using `--prodigy_selection`

### Different chain IDs in CIF vs PDB format

**Issue**: Boltzgen outputs CIF format which may have different chain naming
**Solution**: Inspect your structures and specify appropriate chain IDs

### No PRODIGY results generated

**Check**:
1. Is `--run_prodigy` enabled?
2. Do final_ranked_designs contain CIF files?
3. Are structures valid protein complexes with multiple chains?

## Performance Notes

- **Runtime**: PRODIGY is very fast (~1-5 seconds per structure)
- **Resources**: Minimal - uses `process_low` label
- **Scaling**: Can analyze hundreds of designs in parallel efficiently
- **Storage**: Small output files (~5-10 KB per structure)

## Related Documentation

- [IPSAE Scoring](../README.md#ipsae-scoring) - Protein-protein interface evaluation
- [Boltzgen Documentation](https://github.com/HannesStark/boltzgen) - Structure prediction
- [Pipeline Usage](../USAGE.md) - General pipeline parameters
