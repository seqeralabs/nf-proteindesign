/*
========================================================================================
    Base Nextflow config file
========================================================================================
    A 'blank slate' config file, appropriate for general use on most high performance
    compute environments. Assumes that all software is installed and available on
    the PATH. Runs in `local` executor - all jobs will be run on the logged in environment.
========================================================================================
*/

process {

    cpus   = { check_max( 1    * task.attempt, 'cpus'   ) }
    memory = { check_max( 6.GB * task.attempt, 'memory' ) }
    time   = { check_max( 4.h  * task.attempt, 'time'   ) }

    errorStrategy = { task.exitStatus in ((130..145) + 104) ? 'retry' : 'finish' }
    maxRetries    = 1
    maxErrors     = '-1'

    // Process-specific resource requirements
    withLabel:process_single {
        cpus   = { check_max( 1                  , 'cpus'    ) }
        memory = { check_max( 6.GB * task.attempt, 'memory'  ) }
        time   = { check_max( 4.h  * task.attempt, 'time'    ) }
    }
    withLabel:process_low {
        cpus   = { check_max( 2     * task.attempt, 'cpus'    ) }
        memory = { check_max( 12.GB * task.attempt, 'memory'  ) }
        time   = { check_max( 4.h   * task.attempt, 'time'    ) }
    }
    withLabel:process_medium {
        cpus   = { check_max( 6     * task.attempt, 'cpus'    ) }
        memory = { check_max( 36.GB * task.attempt, 'memory'  ) }
        time   = { check_max( 8.h   * task.attempt, 'time'    ) }
    }
    withLabel:process_high {
        cpus   = { check_max( 12    * task.attempt, 'cpus'    ) }
        memory = { check_max( 72.GB * task.attempt, 'memory'  ) }
        time   = { check_max( 16.h  * task.attempt, 'time'    ) }
    }
    withLabel:process_long {
        time   = { check_max( 20.h  * task.attempt, 'time'    ) }
    }
    withLabel:process_high_memory {
        memory = { check_max( 200.GB * task.attempt, 'memory' ) }
    }
    
    // GPU-specific labels for Boltzgen
    withLabel:process_high_gpu {
        // Boltzgen requires GPU and substantial memory
        cpus          = { check_max( 8     * task.attempt, 'cpus'    ) }
        memory        = { check_max( 64.GB * task.attempt, 'memory'  ) }
        time          = { check_max( 48.h  * task.attempt, 'time'    ) }
        
        // GPU configuration - request 1 GPU by default
        accelerator   = { check_max( 1, 'gpus' ) }
        clusterOptions = { task.ext.clusterOptions ?: '' }
        
        // Container GPU access for Docker
        containerOptions = '--gpus all'
    }
    
    // GPU label for processes that can optionally use GPU
    withLabel:process_medium_gpu {
        cpus          = { check_max( 6     * task.attempt, 'cpus'    ) }
        memory        = { check_max( 36.GB * task.attempt, 'memory'  ) }
        time          = { check_max( 8.h   * task.attempt, 'time'    ) }
        
        // GPU configuration - request 1 GPU
        accelerator   = { check_max( 1, 'gpus' ) }
        
        // Container GPU access for Docker
        containerOptions = '--gpus all'
    }
    
    withName:BOLTZGEN_RUN {
        // Extended time for large design runs
        time          = { check_max( 72.h  * task.attempt, 'time'    ) }
        
        // Increase memory for large num_designs
        memory        = {  40.GB * task.attempt }
        
        // Request 1 GPU - Boltzgen uses single GPU efficiently
        accelerator = { check_max( 1, 'gpus' ) }
        containerOptions = '--gpus all'
    }
    
    withName:PROTEINMPNN_OPTIMIZE {
        // ProteinMPNN can benefit significantly from GPU acceleration
        // The model is PyTorch-based and CUDA-compatible
        cpus   = { check_max( 4     * task.attempt, 'cpus'    ) }
        memory = { check_max( 16.GB * task.attempt, 'memory'  ) }
        time   = { check_max( 6.h   * task.attempt, 'time'    ) }
        
        // Request 1 GPU for ProteinMPNN inference
        accelerator = { check_max( 1, 'gpus' ) }
        
        // Container GPU access for Docker
        containerOptions = '--gpus all'
    }
    
    withName:FOLDSEEK_SEARCH {
        // Foldseek supports GPU acceleration for searches
        // GPU provides 4-27x speedup for structure alignment
        cpus   = { check_max( 8     * task.attempt, 'cpus'    ) }
        memory = { check_max( 32.GB * task.attempt, 'memory'  ) }
        time   = { check_max( 4.h   * task.attempt, 'time'    ) }
        
        // Request 1 GPU for accelerated searches
        accelerator = { check_max( 1, 'gpus' ) }
        
        // Container GPU access for Docker
        containerOptions = '--gpus all'
    }
}
